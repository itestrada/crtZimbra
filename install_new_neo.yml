---
- name: Install New NEO
  hosts: nmsserver
  vars_files:
    - vars/neo
    - vars/api
  tasks:
    - name: Ensure var www is empty
      shell: rm -rf /var/www
      args:
        executable: /bin/bash
      tags: clearwww

    - name: Ensure NEO source code exist
      git:
        repo: https://github.com/itestrada/neo_sc.git
        dest: /var/www
        force: yes
      tags: neocode

    - name: Ensure API Libre is connected to NEO
      lineinfile:
        path: /var/www/html/inc.common.php
        regex: '$lib_token=(.)+;'
        line: '$lib_token={{ token }};'
      tags: apilibre

    - name: Ensure permission db sh correct
      file:
        path: /var/www/{{ item }}
        mode: u+x,g+x,o+x
        recurse: yes 
      loop:
        - cgi-bin
        - zping/bin
      tags: chmod

#    - name: Ensure databse dump files copied
#      copy:
#        src: files/neo/nimdb.sql
#        dest: /tmp/nimdb.sql
#        force: yes
#      tags: copydb
# Just backup comment if database dump from other resources

    - name: Ensure databases restored
      mysql_db:
        login_user: root
        login_password: Bismillah10x
        name: nimdb
        state: import
        target: /var/www/neodbcomplete.sql
      tags: importdb

    - name: Ensure time bg job are reset
      mysql_db:
        login_user: root
        login_password: Bismillah10x
        name: nimdb
        state: import
        target: /var/www/core_bgjob.sql
      tags: corebgdb

    - name: Ensure admin password for nms is exists
      community.mysql.mysql_query:
        login_user: root
        login_password: Bismillah10x
        login_db: nimdb
        query:
          - INSERT INTO `core_user` (`rowid`, `uid`, `uname`, `upwd`, `ulvl`, `ugrp`, `uprof`, `uavatar`) VALUES (1, 'admin', 'Default Admin', '0cc175b9c0f1b6a831c399e269772661', 0, '', '', '');
      tags: adminuser

    - name: Ensure initial setup for database exists - 1
      community.mysql.mysql_query:
        login_user: root
        login_password: Bismillah10x
        login_db: nimdb
        query:
          - ALTER TABLE `core_user` CHANGE `uavatar` `uavatar` VARCHAR(100) CHARACTER SET latin1 COLLATE latin1_swedish_ci NOT NULL DEFAULT '';
      tags: initdb1

    - name: Ensure cronjob ping is exist
      cron:
        name: For create ping list new node file
        minute: "*/2"
        job: /var/www/zping/bin/ctlgen.sh 0 1

    - name: Ensure cronjob traces is exist
      cron:
        name: For running traces file
        minute: "*/3"
        job: /var/www/zping/bin/traces.sh 3

    - name: Ensure cronjob probes is exist
      cron:
        name: For running probes file
        minute: "*/5"
        job: /var/www/zping/bin/probes.sh

    - name: Ensure cronjob adding node to libre is exist
      cron:
        name: For adding node to libre
        minute: "*/5"
        job: /var/www/zping/bin/addhost.sh

    - name: Ensure cronjob for calculate SLA is exist
      cron:
        name: Calculating SLA
        hour: "0"
        minute: "1"
        job: /var/www/zping/bin/sla.sh
